<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <title>Formulario de Registro e Inicio de Sesión</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap');
* {
    padding: 0;
    margin: 0;
    box-sizing: border-box;
    font-optical-sizing: auto;
    font-style: normal;
  }
  
  body {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: url('/static/img/login.jpg');
    background-size: cover;
    background-repeat: no-repeat;
  }
  
  input::placeholder {
    font-family: 'Rubik', sans-serif;
    font-weight: 300; /* Regular */
}

p {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Usamos Segoe UI */
  font-weight: 300; /* Light */
}

.info-childs h2 {
  font-family: 'Montserrat', sans-serif;
  font-weight: 400; /* Regular */
}

.form-information-childs h2 {
  font-family: 'Montserrat', sans-serif;
  font-weight: 500; /* Regular */
}


/* Para los placeholders */
input::placeholder {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Usamos Segoe UI */
  font-weight: 300; /* Light */
}

  
  .contenedor {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    width: 100%;
  }

  .modal {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    width: 100%;
  }
  
    .container-form {
      display: flex;
      border-radius: 20px;
      box-shadow: 0 5px 7px rgba(0, 0, 0, .1);
      height: 500px;
      max-width: 900px;
      transition: all 1s ease;
      margin: 10px;
    }
    
    .information {
      width: 60%;
      display: flex;
      align-items: center;
      text-align: center;
      background-color: #477aa9;
      border-top-left-radius: 20px;
      border-bottom-left-radius: 20px;
      opacity: 0.98;
    }
    
    .info-childs {
      width: 100%;
      padding: 0 30px;
    }
    
    .info-childs h2 {
      font-size: 2.5rem;
      color: #ffffff;
    }
    
    .info-childs p {
      margin: 15px 0 ;
      color: #fff;
    }
    
    .info-childs input {
      background-color: transparent;
      outline: none;
      border: solid 2px #9191bd;
      border-radius: 20px;
      padding: 10px 20px;
      color: #9191bd;
      cursor: pointer;
      transition: background-color .3s ease;
    }
    
    .info-childs input:hover {
      background-color: #9191bd;
      border: none;
      color: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
    }
    
    .form-information {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 80%;
      text-align: center;
      background-color: #f8f8f8;
      border-top-right-radius: 20px;
      border-bottom-right-radius: 20px;
    }
    
    .form-information-childs {
      padding: 0 30px;
    }
    
    .form-information-childs h2 {
      color: #333;
      font-size: 2rem;
    }
    
    .form-information-childs p {
      color: #555;
    }
    
    #sign-in {
      background-color: transparent;
      outline: none;
      border: solid 2px #477aa9;
      border-radius: 20px;
      padding: 10px 20px;
      color: #477aa9;
      cursor: pointer;
      font-family: 'Rubik', sans-serif;  
      font-weight: 300;  
      width: 9rem;
      transition: background-color 0.3s ease;
      margin-right: 0.4rem;
    }

    .h3{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 300;  
    }
  
    #sign-in:hover {
      background-color: #477aa9;
      border: none;
      color: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
    }
  
    .opciones{
      display: flex;
      justify-content: center;
      align-items: center;
    }
  
    #reg{
      background-color: #477aa9;
      color: #fff;
      border-radius: 20px;
      border: solid 2px #477aa9;
      cursor: pointer;
      width: 9rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
      display: flex;
    }
  
    #sign-up {
      background-color: transparent;
      outline: none;
      border: none;
      padding: 0;
      color: #477aa9;
      text-decoration: underline;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 300;                
      font-size: 14px;                 
      cursor: pointer;
      transition: color 0.3s ease;
    }
  
  #sign-up:hover {
      color: #477aa9;
      text-decoration: none;
  }
  
  
  
  
    .icons {
      margin: 15px 0;
    }
    
    .icons i {
      border-radius: 50%;
      padding: 15px;
      cursor: pointer;
      margin: 0 10px;
      color: #9191bd;
      border: solid thin #9191bd;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
    }
    
    .icons i:hover {
      background-color: #c7c7f3;
      color: #fff;
    }
    
    .form {
      margin: 30px 0 0 0;
    }
    
    .form label {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      border-radius: 20px;
      padding: 0 10px;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
    }
    
    .form label input {
      width: 100%;
      padding: 10px;
      background-color: #fff;
      border: none;
      outline: none;
      border-radius: 20px;
      color: #333;
    }
    
    .form label i {
      color: #477aa9;
    }
    
    .form input[type="submit"] {
      background-color: #477aa9;
      color: #fff;
      border-radius: 20px;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Rubik', sans-serif;  
      font-weight: 300;  
      width: 18rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
    }
    
    .form input[type="submit"]:hover {
      background-color: #3b6a96;
    }
    
    .hide {
      visibility: hidden; /* Oculta el formulario visualmente */
      opacity: 0;         /* Hace que sea completamente transparente */
      position: absolute; /* Asegura que no ocupe espacio */
      transform: translateY(-300%); /* MantÃ©n el desplazamiento */
      transition: all 0.3s ease-in-out; /* Agrega transiciones suaves */
  }
  
    
    
    /*PERSONALIZACION DE MIS ALERTAS Y MENSAJES */
    .form div .alerta {
      width: 290px;
      text-align: left;
      border-radius: 7px;
      margin-bottom: 10px;
      font-size: .8rem;
    }
    
    .form > .alerta-error,
    .form > .alerta-exito {
      display: none;
    }
    
    .form .alertaError {
      display: block;
      background-color: #F66060;
      padding: .5rem 1rem;
      margin-top: 10px;
      font-weight: 500;
      font-size: .8rem;
    }
    
    .form .alertaExito {
      display: block;
      background-color: #0ca828;
      padding: .5rem 1rem;
      margin-top: 10px;
      font-weight: 500;
      font-size: .8rem;
    }
    
    .form .error {
      outline: solid 2px #9d2222;
    }
    
    /*RESPONSIVE FORM*/
    
    @media screen and (max-width:750px) {
      html {
        font-size: 12px;
      }
    }
    
    @media screen and (max-width:580px) {
      html {
        font-size: 15px;
      }
    
      .container-form {
        height: auto;
        flex-direction: column;
      }
    
      .information {
        width: 100%;
        padding: 20px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0;
      }
    
      .form-information {
        width: 100%;
        padding: 20px;
        border-bottom-left-radius: 20px;
        border-top-right-radius: 0;
      }


    }
</style>


<body>
    <div class="contenedor">
        <div class="modal">
            <!-- Formulario de Registro -->
            <div class="container-form register hide"> <!-- Agregado hide aquí -->
                <div class="information">
                    <div class="info-childs">
                        <h2>Únete a nosotros</h2>
                        <p>Para unirte a nuestra comunidad por favor registra tus datos</p>
                    </div>
                </div>
                <div class="form-information">
                    <div class="form-information-childs">
                        <h2>Crear una cuenta</h2>
                        <form method="POST" class="form form-register" onsubmit="crear_cuenta(event)"
                            id="frm_crearcuenta">
                            <div>
                                <label>
                                    <i class='bx bx-user'></i>
                                    <input type="text" placeholder="Apellidos y nombres" name="apellido_nombre"
                                        required>
                                </label>
                            </div>
                            <div>
                                <label>
                                    <i class='bx bx-envelope'></i>
                                    <input type="email" placeholder="Correo electrónico" name="correo" required>
                                </label>
                            </div>
                            <div>
                                <label>
                                    <i class='bx bx-phone'></i>
                                    <input type="number" max="999999999" min="900000000" placeholder="Teléfono"
                                        name="telefono" required>
                                </label>
                            </div>
                            <div>
                                <label>
                                    <i class='bx bx-lock-alt'></i>
                                    <input id="pa" type="password" placeholder="Contraseña" name="contraseña" required>
                                    <button type="button" class="btn border-0" onclick="ver_password('pa', 'icon_rg')">
                                        <i class="bi bi-eye-fill" id="icon_rg"></i>
                                    </button>
                                </label>
                            </div>                                                                
                            <div class="opciones">
                                <input type="button" value="Iniciar sesión" id="sign-in">
                                <input type="submit" value="Registrarse" id="reg">
                            </div>

                        </form>
                    </div>
                </div>
            </div>

            <!-- Formulario de Login -->
            <div class="container-form login"> <!-- Sin la clase hide para que se muestre primero -->
                <div class="information">
                    <div class="info-childs">
                        <h2>Bienvenido</h2>
                    </div>
                </div>
                <div class="form-information">
                    <div class="form-information-childs" onsubmit="iniciar_sesion(event)">
                        <h2>Iniciar sesión</h2>
                        <form method="POST" class="form form-login" id="formulario_uno">
                            <div>
                                <label>
                                    <i class='bx bx-envelope'></i>
                                    <input type="email" placeholder="Correo electrónico" name="correo" required>
                                </label>
                            </div>
                            <div>
                                <label>
                                    <i class='bx bx-lock-alt'></i>
                                    <input id="ps" type="password" placeholder="Contraseña" name="contraseña" required>
                                    <button type="button" class="btn border-0" onclick="ver_password('ps', 'icon_ps')">
                                        <i class="bi bi-eye-fill" id="icon_ps"></i>
                                    </button>
                                </label>
        
                            </div>
                            <input type="submit" value="Ingresar" id="ingr">
                            <div style="margin-top: 15px;">
                                <h3 style="display: inline; font-size: 16px; margin-right: 10px; font-weight: normal;">
                                    Si no tienes cuenta,</h3>
                                <a href="" id="sign-up">Regístrate aquí</a>.
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>




    </div>

</body>
<script>
    const btnSignIn = document.getElementById("sign-in"),
    btnSignUp = document.getElementById("sign-up"),
    containerFormRegister = document.querySelector(".register"),
    containerFormLogin = document.querySelector(".login"),
    loginButton = document.getElementById("ingr"); // Botón de inicio de sesión

const MAX_INTENTOS = 5;
const TIEMPO_BLOQUEO = 1 * 60 * 1000; // 1 minuto en milisegundos

btnSignIn.addEventListener("click", e => {
  e.preventDefault();
  containerFormRegister.classList.add("hide");
  containerFormLogin.classList.remove("hide");
  containerFormLogin.reset();
});

btnSignUp.addEventListener("click", e => {
  e.preventDefault();
  containerFormLogin.classList.add("hide");
  containerFormRegister.classList.remove("hide");
  ver_password('ps', 'icon_ps','cerrar');
  limpiar_campos();
});

window.addEventListener('load', () => {
  verificarBloqueo(); // Verificar si el usuario está bloqueado
  limpiar_campos();
});

function iniciar_sesion(event) {
  let intentosFallidos = parseInt(localStorage.getItem("intentosFallidos")) || 0;

  if (estaBloqueado()) {
      event.preventDefault();
      mostrarMensajeBloqueo();
      return;
  }

  let formulario_sesion = document.getElementById('formulario_uno');
  let formulario_1 = new FormData(formulario_sesion);

  if (formulario_sesion.checkValidity() == false) {
      return;
  }
  event.preventDefault();

  fetch('/login', {
      method: 'POST',
      body: formulario_1
  })
  .then(response => response.json())
  .then(data => {
      if (data.estado === "error") {
          intentosFallidos++;
          localStorage.setItem("intentosFallidos", intentosFallidos);

          if (intentosFallidos >= MAX_INTENTOS) {
              localStorage.setItem("bloqueoInicio", Date.now());
              mostrarMensajeBloqueo();
              bloquearBoton();
          } else {
              alert("Verifique su contraseña o correo. Intentos restantes: " + (MAX_INTENTOS - intentosFallidos));
          }
      } else {
          localStorage.setItem("intentosFallidos", 0);
          window.location.href = data.redirect;
      }
  });
}

function estaBloqueado() {
  let bloqueoInicio = localStorage.getItem("bloqueoInicio");
  if (bloqueoInicio) {
      let tiempoRestante = TIEMPO_BLOQUEO - (Date.now() - bloqueoInicio);
      return tiempoRestante > 0;
  }
  return false;
}

function mostrarMensajeBloqueo() {
  let bloqueoInicio = localStorage.getItem("bloqueoInicio");

  if (bloqueoInicio) {
      let tiempoRestante = TIEMPO_BLOQUEO - (Date.now() - bloqueoInicio);
      if (tiempoRestante > 0) {
          iniciarContadorBloqueo(Math.ceil(tiempoRestante / 1000));
      }
  }
}

function bloquearBoton() {
  loginButton.disabled = true;
  mostrarMensajeBloqueo();
}

function ver_password(input , icon, accion){
  const password = document.getElementById(input);
  const icono = document.getElementById(icon);
  if (accion == "cerrar"){
      if (icono.classList.contains("bi-eye-slash-fill")){
          icono.classList.remove("bi-eye-slash-fill");
          icono.classList.add("bi-eye-fill");
          password.type = "password";
      }
  }else{
      if (icono.classList.contains("bi-eye-fill")){
          icono.classList.remove("bi-eye-fill");
          icono.classList.add("bi-eye-slash-fill");
          password.type = "text";
      }else{
          password.type = "password";
          icono.classList.add("bi-eye-fill");
          icono.classList.remove("bi-eye-slash-fill");
      }
  }
}

function desbloquearBoton() {
  loginButton.disabled = false;
}

function verificarBloqueo() {
  if (estaBloqueado()) {
      bloquearBoton();
      setTimeout(() => {
          localStorage.removeItem("bloqueoInicio");
          localStorage.setItem("intentosFallidos", 0);
          desbloquearBoton();
      }, TIEMPO_BLOQUEO);
  }
}


function limpiar_campos() {
  let items = document.querySelectorAll('input');
  const ids = ["ingr", "sign-in", "reg"];
  Array.from(items).forEach(element => {
      if (!ids.includes(element.id)) {
          element.value = "";
      }
  });
}

function ver_password(inputId, iconId) {
  var input = document.getElementById(inputId);
  var icon = document.getElementById(iconId);

  // Cambiar tipo de input entre password y text
  if (input.type === "password") {
      input.type = "text";  // Muestra la contraseña
      icon.classList.remove("bi-eye-fill");
      icon.classList.add("bi-eye-slash-fill"); // Cambia el ícono
  } else {
      input.type = "password";  // Oculta la contraseña
      icon.classList.remove("bi-eye-slash-fill");
      icon.classList.add("bi-eye-fill"); // Vuelve al ícono original
  }
}


function crear_cuenta(event){
  let contraseña = document.getElementsByName('contraseña')[0].value;

  const tieneMayuscula = /[A-Z]/.test(contraseña);
  const tieneSimbolo = /[!@#$%^&*(),.?":{}|<>/]/.test(contraseña);
  const tieneNumero = /[0-9]/.test(contraseña);
  const tieneMinuscula = /[a-z]/.test(contraseña);

  if (!tieneMayuscula || !tieneSimbolo || !tieneNumero || !tieneMinuscula) {
      alert("La contraseña debe contener al menos una letra mayúscula, un símbolo, un número y una letra minúscula.");
      event.preventDefault();
  }else{
      let frm_crearcuenta = document.getElementById('frm_crearcuenta');
      let frm_envio = new FormData(frm_crearcuenta);
  
      if (frm_crearcuenta.checkValidity() == false){
          return ;
      }
      event.preventDefault();
  
      fetch('/registro', {
          method: 'POST',
          body: frm_envio
      })
      .then(response => response.json())
      .then(data => {
          if (data.estado == "error") {
              alert("no se pudo crear la cuenta");
          }else  if(data.estado == "existe"){
              alert("Ese usuario ya existe");
          }else{
              window.location.href = data.redirect;
          }
      })
  }


}



//Lo mas importante seguridad
window.addEventListener( "pageshow", function ( event ) {
  if ( event.persisted ) {
         window.location.reload();
       }
});

</script>

</html>
<script src="{{ url_for('static', filename='js/login.js') }}"></script>